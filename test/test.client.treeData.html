<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="qunit-1.10.0.css" />
	<script src="qunit-1.10.0.js"></script>
	<script src="../client/treeData.js"></script>
	<script>
	function testWordIsNotSearchTerm(first,wordArray) {
		if(first == true) {
			myFunction = firstWordIsNotSearchTerm;
		} else {
			myFunction = lastWordIsNotSearchTerm;
		}
		var singleWordArray = ["words"];
		equal(myFunction(wordArray,"balloon"),false,"first/last word is search term");
		equal(myFunction(wordArray,"balloons"),false,"search term is plural form of first/last word");
		equal(myFunction(wordArray,"Balloon"),false,"first/last word has different capitalisation");
		equal(myFunction(wordArray,"balloon,"),false,"search term has trailing punctuation");
		equal(myFunction(wordArray,"moon"),true,"search term is in wordArray but not first/last word");
		equal(myFunction(wordArray,""),true,"search term is empty string");
		equal(myFunction(wordArray,"the"),true,"search term is first word");
		equal(myFunction(wordArray,null),true,"search term is null");
		equal(myFunction(singleWordArray,"word"),false,"word array has one word, word is singular form of search term");
		equal(myFunction(singleWordArray,"words"),false,"word array has one word");
		equal(myFunction(singleWordArray,"foo"),true,"word array has one word, doesn't match search term");
	}
	
	test("lastWordIsNotSearchTerm test", function() {
		var wordArray = ["the","moon","is","a","balloon"];
		testWordIsNotSearchTerm(false,wordArray);		
	});
	
	test("firstWordIsNotSearchTerm test", function() {
		var wordArray = ["balloon","a","is","moon","the"];
		testWordIsNotSearchTerm(true,wordArray);			
	});
	
	test("removeTrailingPunctuation test", function() {
		equal(removeTrailingPunctuation("hello"),"hello","don't alter word with no trailing punctuation");
		equal(removeTrailingPunctuation("Hello"),"hello","to lower case");	
		equal(removeTrailingPunctuation("hello,"),"hello","remove trailing comma");		
		equal(removeTrailingPunctuation("hello."),"hello","remove trailing period");	
		equal(removeTrailingPunctuation("hello:"),"hello","remove trailing colon");	
		equal(removeTrailingPunctuation("hello;"),"hello","remove trailing semicolon");	
		equal(removeTrailingPunctuation("hello'"),"hello","remove trailing single quote");	
		equal(removeTrailingPunctuation("hello?"),"hello","remove trailing question mark");	
		equal(removeTrailingPunctuation("hello!"),"hello","remove trailing exclamation");
		equal(removeTrailingPunctuation("hello,,"),"hello","remove multiple trailing punctuation marks");			
		equal(removeTrailingPunctuation(""),"","empty string");
		equal(removeTrailingPunctuation(null),null,"null input");	
	});
	
	test("prune term", function() {
		var wordArray = ["balloon","a","is","moon","the"];
		var test1Array = wordArray.slice(), 
			test2Array = wordArray.slice(), 
			test3Array = wordArray.slice(),
			test4Array = wordArray.slice(), 
			test5Array = wordArray.slice()
			test6Array = wordArray.slice();
		
		var singleWordArray = ["balloon"];
		deepEqual(pruneTerm(test1Array,"is"),["is","moon","the"],"strip initial words if they don't match exactly");
		deepEqual(pruneTerm(test2Array,"balloon"),["balloon","a","is","moon","the"],"do nothing if first word matches");
		deepEqual(pruneTerm(test3Array,"foo"),[],"return nothing if nothing matches");
		deepEqual(pruneTerm(singleWordArray,"balloon"),["balloon"],"single word array which matches");
		deepEqual(pruneTerm(singleWordArray,"foo"),[],"return nothing if nothing matches, one word");
		deepEqual(pruneTerm(test4Array,"Balloon"),["balloon","a","is","moon","the"],"Match different capitalisation");
		deepEqual(pruneTerm(test5Array,"balloon,"),["balloon","a","is","moon","the"],"Match with trailing punctuation");
		deepEqual(pruneTerm(test6Array,"balloons"),["balloon","a","is","moon","the"],"Match plural form");
		


	
	});
    
    test("create dataTree", function() {
    
        var phrase1 = "Tennis ball";
        var phrase2 = "Lots and lots and lots and lots of words in the phrase";
        var phrase3 = "some  values";
        var phrase4 = "some 1 numeric values";
        var phrase5 = "word";
        var phrase6 = "Tennis ball";
    
        var cleanPhrase1 = ["Tennis","ball"];
        var cleanPhrase2 = ["lots","and","lots","and","lots","and","lots","of","words","in","the","phrase"];
        var cleanPhrase3 = ["some",null,"values"];
        var cleanPhrase4 = ["some",1,"numeric","values"];
        var cleanPhrase5 = ["word"];
        var cleanPhrase6 = ["Tennis","ball"];

        var actualResult1 = new DataTree(phrase1,cleanPhrase1,1,0);
        testDataTree(actualResult1,"Tennis",1,1,"ball",1,0,"basic test");
        var actualResult2 = new DataTree(phrase2,cleanPhrase2,1,0);
        testDataTree(actualResult2,"lots",1,1,"and",1,0,"long phrase");
        equal(actualResult2.children[0].children[0].children[0].children[0].children[0].children[0].children[0].children[0].children[0].children[0].children[0].cleanName,"phrase","long phrase : last word");
        var actualResult3 = new DataTree(phrase3,cleanPhrase3,1,0);
        testDataTree(actualResult3,"some",1,1,null,1,0,"null value");
        var actualResult4 = new DataTree(phrase4,cleanPhrase4,1,0);
        testDataTree(actualResult4,"some",1,1,"1",1,0,"numeric value");
        var actualResult5 = new DataTree(phrase5,cleanPhrase5,1,0);
        testDataTree(actualResult5,"word",0,1,1,0,undefined,"one word phrase");
        var actualResult6 = new DataTree(phrase6,cleanPhrase6,9283,100);
        testDataTree(actualResult6,"Tennis",1,9283,"ball",9283,100,"value and matchingTermIndex");
    });
    
    function testDataTree(actualResult,expectedname,expectedChildren,expectedRootValue,expectedFirstChildName,expectedFirstChildValue,expectedFirstChildMatchingTermIndex,description) {
        equal(actualResult.cleanName,expectedname,description + " : test name")
        equal(actualResult.children.length,expectedChildren,description + " : number of children");
        equal(actualResult.value,expectedRootValue,description + " : root value");
        if(actualResult.children.length>0) {
            equal(actualResult.children[0].cleanName,expectedFirstChildName,description + " : first child name");
            equal(actualResult.children[0].value,expectedFirstChildValue,description + " : first child value");    
            equal(actualResult.children[0].matchingTermIndex,expectedFirstChildMatchingTermIndex,description + " : first child matchingTermIndex");
        }
    }

    test("merge tree", function() {
        //name (matchingTermIndex)
        //Input
        //  tennis ball (0)
        //  tennis racket (1)
        //  tennis racket strings (2)
        //Output
        //  tennis ("0,1,2") 
        //      ball ("0")
        //      racket ("1,2")
        //          strings ("2")
    
        var tree1 = new DataTree("tennis ball",["tennis","ball"],1,0);
        var tree2 = new DataTree("tennis racket",["tennis","racket"],1,1);
        var mergedTrees = mergeTrees(tree1,tree2);
        testDataTree(mergedTrees,"tennis",2,2,"ball",1,0,"mergedTree");
        strictEqual(mergedTrees.children[1].cleanName,"racket","second child name");   
        var tree3 = new DataTree("tennis racket strings",["tennis","racket","strings"],20,2);
        var secondGenerationMerge = mergeTrees(mergedTrees,tree3);
        testDataTree(secondGenerationMerge,"tennis",2,22,"ball",1,0,"second generation merged tree");
        strictEqual(secondGenerationMerge.children[1].cleanName,"racket","second child name"); 
        strictEqual(secondGenerationMerge.children[1].children[0].cleanName,"strings","grandchild name");
        strictEqual(secondGenerationMerge.matchingTermIndex,"0,1,2","root level matching term index");
        strictEqual(secondGenerationMerge.children[0].matchingTermIndex,"0","first child matching term index");
        strictEqual(secondGenerationMerge.children[1].matchingTermIndex,"1,2","second child matching term index");
        strictEqual(secondGenerationMerge.children[1].children[0].matchingTermIndex,"2","grandchild matching term index");
    });
    
    test("DataTree.getChildIndex", function () {
        var tree1 = new DataTree("tennis ball",["tennis","ball"],1,0);
        var tree2 = new DataTree("tennis racket",["tennis","racket"],1,1);
        var mergedTrees = mergeTrees(tree1,tree2);
        var tree3 = new DataTree("tennis racket strings",["tennis","racket","strings"],20,2);
        var secondGenerationMerge = mergeTrees(mergedTrees,tree3);
        
        strictEqual(tree1.getChildIndex("ball"),0,"simple positive case");
        strictEqual(tree1.getChildIndex("foo"),-1,"simple negative case");
        strictEqual(mergedTrees.getChildIndex("racket"),1,"positive testing with two children");
        strictEqual(mergedTrees.getChildIndex(null),-1,"pass null");
        strictEqual(secondGenerationMerge.getChildIndex("racket"),1,"testing with grandchildren");
    });
    
    test("nestTreeData", function () {
        var inputData = [
                {"name":"tennis ball","cleanName":["tennis","ball"],"value":1,"matchingTermIndex":0},
                {"name":"tennis racket,","cleanName":["tennis","racket"],"value":1,"matchingTermIndex":1},
                {"name":"Tennis racket strings","cleanName":["tennis","racket","strings"],"value":20,"matchingTermIndex":2},
                {"name":"tennis Ball Bounciness!","cleanName":["tennis","ball","bounciness"],"value":5,"matchingTermIndex":3},
                {"name":"Tennis umpire seat","cleanName":["tennis","umpire","seat"],"value":7,"matchingTermIndex":4},
                {"name":"tennis score ","cleanName":["tennis","score",""],"value":13,"matchingTermIndex":5}                
            ];
        testDataTree(nestTreeData(inputData,"tennis"),"tennis",4,47,"ball",6,"0,3","nestTreeData positive case");
        
        var inputData1 = [{"cleanName":["tennis","ball"],"value":1,"matchingTermIndex":0}];
        testDataTree(nestTreeData(inputData1,"tennis"),"tennis",1,1,"ball",1,"0","nestTreeData single term");
        
        var inputData2 = [{"cleanName":["tennis"],"value":1,"matchingTermIndex":0}];
        testDataTree(nestTreeData(inputData2,"tennis"),"tennis",0,1,undefined,undefined,undefined,"nestTreeData single word term");
    });
    
    test("create term", function() {
        var matchingTerm = {
                name:"Bouncy tennis ball",
                cleanName:["bouncy","tennis","ball"],
                value:1
            };
        var matchingTermIndex = 0;
        var searchTerm = "tennis";
        var isPost = false;
        
        var actualResult = createTerm(matchingTerm,matchingTermIndex,searchTerm,isPost);
      
        equal(actualResult.cleanName[0],"tennis","pre: first word in name");
        equal(actualResult.cleanName[1],"ball","pre: second word in name");
        equal(actualResult.value,1,"pre: value");
        equal(actualResult.matchingTermIndex,"0","pre: matchingTermIndex");
        
        var actualResult1 = createTerm(matchingTerm,matchingTermIndex,searchTerm,true);
        equal(actualResult1.cleanName[0],"tennis","post: first word in name");
        equal(actualResult1.cleanName[1],"bouncy","post: second word in name");
        equal(actualResult1.value,1,"post: value");
        equal(actualResult1.matchingTermIndex,"0","post: matchingTermIndex");
    });
    
    test("processTreeData", function() {
        var searchTerm = "tennis";
        var postTreeData1 = [], preTreeData1 = [];
        var matchingTerms1 = [
                {"name":"tennis ball",value:1},
                {"name":"bouncy tennis ball",value:13},
                {"name":"tennis racket",value:7}
            ];
        var postTreeData2 = [], preTreeData2 = [];
        var matchingTerms2 = [
                {"name":"Tennis ball",value:1},
                {"name":"bouncy, tennis ball",value:13},
                {"name":"tennis  racket.",value:7}
            ];
        var actualResult1 = processTreeData(matchingTerms1,searchTerm,postTreeData1,preTreeData1);
        var actualResult2 = processTreeData(matchingTerms2,searchTerm,postTreeData2,preTreeData2);
        
        equal(postTreeData1[0].cleanName[0],"tennis","base case: post tree root name");
        equal(postTreeData1[1].cleanName[1],"ball","base case: post tree other name");
        equal(postTreeData1[0].matchingTermIndex,"0","base case : post tree root matchingTermIndex");
        equal(preTreeData1[0].cleanName[0],"tennis","base case: pre tree root name");
        equal(preTreeData1[0].cleanName[1],"bouncy","base case: pre tree other name");
        equal(preTreeData1[0].matchingTermIndex,"1","base case : pre tree root matchingTermIndex");
        
        equal(postTreeData2[0].cleanName[0],"tennis","advanced case: post tree root name");
        equal(postTreeData2[1].cleanName[1],"ball","advanced case: post tree other name");
        equal(postTreeData2[0].matchingTermIndex,"0","advanced case : post tree root matchingTermIndex");
        equal(preTreeData2[0].cleanName[0],"tennis","advanced case: pre tree root name");
        equal(preTreeData2[0].cleanName[1],"bouncy","advanced case: pre tree other name");
        equal(preTreeData2[0].matchingTermIndex,"1","advanced case : pre tree root matchingTermIndex");
        
    });
	</script>
</head>
<body>
	<div id="qunit"></div>
</body>
</html>