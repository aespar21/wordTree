<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <title>Word Tree</title>
        <link type="text/css" rel="stylesheet" href="style.css"/>
        <link type="text/css" rel="stylesheet" href="bootstrap.min.css"/>
        <link type="text/css" rel="stylesheet" href="darkstrap.css"/>
        <![if (IE 9)|(!IE)]> 
        <script type="text/javascript" src="jQuery-1.8.1.js" ></script>
        <script type="text/javascript" src="bootstrap-transition.js"></script>
        <script type="text/javascript" src="bootstrap-collapse.js"></script>
        <script type="text/javascript" src="d3.js"></script>
        <script type="text/javascript" src="d3.layout.js"></script>
        <script type="text/javascript" src="wordTree.js"></script>
        <script type="text/javascript" src="search.js"></script>
         <![endif]>
    </head>
    <body>
        <div class="main">
        <![if !IE]>
        <div style="display:none">
        <![endif]>
        <![if lt IE 9]>
        <div>Unfortunately, this visualisation only works in IE9 or above. Please upgrade or use Chrome or Firefox instead.</div>
        <![endif]>
        <![if !IE]>
        </div>
        <![endif]>

        <![if (IE 9)|(!IE)]>

		<div class="row-fluid">
            <div class="span10"><h1>Book Fingerprinter <small>Using a <a href="http://www-958.ibm.com/software/data/cognos/manyeyes/page/Word_Tree.html">word tree</a> to compare writing style &nbsp;&nbsp;</small></div>
            <div class="span2"></div><button type="button" class="btn btn-info" data-toggle="collapse" data-target="#collapser">More Info</button></h1></div>
        </div>
        <div class="row-fluid collapse" id="collapser">
            <div class="span6 offset1" >
                <p>
                    This app takes a word which you enter in the input box below and finds all the uses of that word in two different books.
                </p>
                <p>
                    It then creates a word tree for the top 20 or so words which are found in the immediate context of the chosen word. Words which occur less than 2 times aren't shown, and only the top 20 or so are shown.
                </p>
                <p>
                    Feel free to mouse-over a word to see the context, click on a word to make a query against all uses of that word, or to change the books to query.
                </p></div>
        </div>

        <div class="row-fluid">
			<div class="span10 offset1">
                <form class="form-inline">
                    <span>Search for uses of </span>
                    <input type="text" class="input-small" id="search" value="light" />
                    <span>in </span>
                    <select id="bookChooser1" class="input-xlarge"></select>
                    <span>and </span>
                    <select id="bookChooser2" class="input-xlarge"></select>
                    <input class="button btn-info" id="searchButton" type="button" value="go" />
                </form>
                <div class="error" id="errorDiv">Nothing matches your search term. Please try something different</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span6">
				<div class="bookTree">
					<div id="results2"></div>
				</div>
			</div>
			<div class="span6"> 
				<div class="bookTree">
					<div id="results"></div>
				</div>
			</div>
		</div>
        
        <script type="text/javascript">
            $(document).ready(function() {
                //If someone hits enter then act as if they clicked the search button
                $("#search").bind("keypress", function(event){
                    var code = event.keyCode || event.which;
                    if(code == 13){
                        event.preventDefault();
                        $("#searchButton").click();
                    }
                });

                $("#searchButton").click(function() {
                    updateTree($("#search").val());
                });

                var initialSearchTerm = "light";
                
                var books = [
						{
							"id":0,
							"author":"James Joyce",
							"title":"Ulysses",
							"param":"ulysses"
						},
						{
							"id":1,
							"author":"Charles Dickens",
							"title":"David Copperfield",
							"param":"copperfield"
						},
                        {
                            "id":2,
                            "author":"Jane Austen",
                            "title":"Pride and Prejudice",
                            "param":"pride"
                        },
                        {
                            "id":3,
                            "author":"Rudyard Kipling",
                            "title":"The Jungle Book",
                            "param":"jungle"
                        },
                        {
                            "id":4,
                            "author":"Leo Tolstoy",
                            "title":"War and Peace",
                            "param":"warAndPeace"
                        }
					];
					
				var bookChooser1 = $("#bookChooser1");
				$.each(books, function() {
					bookChooser1.append($("<option />").val(this.id).text(this.author + " - " + this.title));
				});
				bookChooser1.change(function() {
					updateTree($("#search").val(),"tree1");
				});
				
				
				var bookChooser2 = $("#bookChooser2");
				$.each(books, function() {
					bookChooser2.append($("<option />").val(this.id).text(this.author + " - " + this.title));
				});
				
				bookChooser2.change(function() {
					updateTree($("#search").val(),"tree2");
				});
				
				$(".clickToQuery").click(function(eventObj) {
					updateTree(eventObj.srcElement.innerText);
				});

                         
                //configure the tree visualisation
                var tree = wordTree()
                    .searchTerm(initialSearchTerm)
                    .width($(window).width()/12*6)
                    .height($(window).height()-200)
                    .maxResults(50)
                    .margins([10,10,10,10])
                    .onClick(function(d) { 
                        if (d.isButton) {
                            console.log("search for " + d.name); 
                        } else {
                            updateTree(d.cleanName); 
                        }
                    })
                    .mouseoverText(function(d) { return d.name; })
                    .useButtonNav(true)
                    .maxDepth(5);

                var tree2 = wordTree()
                    .searchTerm(initialSearchTerm)
                    .width($(window).width()/12*6)
                    .height($(window).height()-200)
                    .maxResults(50)
                    .margins([10,10,10,10])
                    .onClick(function(d) {
                        if (d.isButton) {
                            console.log("search for " + d.name);
                        } else {
                            updateTree(d.cleanName);
                        }
                    })
                    .mouseoverText(function(d) {return d.name; })
                    .useButtonNav(true)
                    .maxDepth(5);
                    
                bookChooser2.val(1).change();
				bookChooser1.val(0).change();
                
                function updateTree(searchTerm,treeToChange) {
                    //update the search input box with the new searchTerm (in case this is called from the onClick event of one of the nodes
                    $("#search").val(searchTerm);
                    $("#selectedText").empty();
                    
                    //Request the data
                    if(!treeToChange || treeToChange == "tree2") {
                        var request = getRequest(searchTerm,books[bookChooser2.val()].param);
                    }

                    if(!treeToChange || treeToChange == "tree1") {
                        var request2 = getRequest(searchTerm,books[bookChooser1.val()].param);
                    }

                    //Update the visualisation settings
                        tree.searchTerm(searchTerm)
                                .width($(window).width()/12*6)
                                .height($(window).height()-200);

                        tree2.searchTerm(searchTerm)
                                .width($(window).width()/12*6)
                                .height($(window).height()-200);

                    //redraw the tree when the data returns
                    if(!treeToChange || treeToChange == "tree2") {
                        request.done(function (data) {
                            tree.preTreeData(data.preTree)
                                .postTreeData(data.postTree)
                                .matchingTerms(data.matchingTerms);

                            d3.select("#results")
                                    .datum(data)
                                    .call(tree);
                        });
                        request.fail(function(errorData, textStatus) {
                            window.console && console.log(errorData);
                            if (errorData.status==404) {
                                errorText = "There is no content which matches your search";
                                $("#errorDiv").html(errorText).show().fadeOut(2000);
                            }
                            else {
                                errorText = "An error occurred on the server";
                                $("#errorDiv").html(errorText).show().fadeOut(2000);
                            }
                        });
                    }

                    if(!treeToChange || treeToChange == "tree1") {
                        request2.done(function (data) {

                            tree2.preTreeData(data.preTree)
                                 .postTreeData(data.postTree)
                                 .matchingTerms(data.matchingTerms);

                            d3.select("#results2")
                                    .datum(data)
                                    .call(tree2);
                        });
                        request2.fail(function(errorData, textStatus) {
                            window.console && console.log(errorData);
                            if (errorData.status==404) {
                                errorText = "There is no content which matches your search";
                                $("#errorDiv").html(errorText).show().fadeOut(2000);
                            }
                            else {
                                errorText = "An error occurred on the server";
                                $("#errorDiv").html(errorText).show().fadeOut(2000);
                            }
                        });
                    }

                }
                
                $(window).resize(function() {
                    //If we resize the window, redraw the tree without requesting new data.
                    tree
                        .width($(window).width()/12*5)
                        .height($(window).height()-200);
                    d3.select("#results")
                        .call(tree);

                    tree2
                        .width($(window).width()/12*5)
                        .height($(window).height()-200);
                    d3.select("#results2")
                        .call(tree2);
                });   
            });
        </script>
        <![endif]>	
        </div>
    </body>
</html>
