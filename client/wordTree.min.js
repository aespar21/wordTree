function wordTree(testMode){var margins=[20,20,20,20],width=$(window).width()-margins[1]-margins[3],height=$(window).height()-margins[0]-margins[2],textSizeMultiplier=width/2e3,maxSize=0,preTreeData=[],postTreeData=[],matchingTerms=[],nameAccessor=function(d){return d.name},valueAccessor=function(d){return d.value},onClick=function(){},maxResults=40,maxDepth=20,mouseoverText=function(d){return d.cleanName},useButtonNav=false,onButtonClick=function(){},buttonText=function(){return["Go"]};function my(selection){selection.each(function(d){var targetElementId=this.id;var targetElement=d3.select("#"+targetElementId);var preTreeData=my.preTreeData();var postTreeData=my.postTreeData();if($("#"+targetElementId+"svg").length==0){var svgElement=targetElement.append("svg:svg").attr("id",targetElementId+"svg");svgElement.append("svg:g").attr("id",targetElementId+"vis");svgElement.append("svg:g").attr("id",targetElementId+"previs")}var d3TreeLayout=d3.layout.tree();d3TreeLayout.size([my.height(),my.width()/2-my.margins()[1]]);d3.select("#"+targetElementId+"svg").attr("width",my.width()-(my.margins()[1]+my.margins()[3])+"px").attr("height",my.height()-(my.margins()[0]+my.margins()[2])+"px");d3.select("#"+targetElementId+"previs").attr("transform","translate("+my.margins()[1]+","+my.margins()[0]+")");d3.select("#"+targetElementId+"vis").attr("transform","translate("+(my.width()/2+my.margins()[1])+","+my.margins()[0]+")");if(preTreeData&&postTreeData){my.maxSize(Math.max(preTreeData.value,postTreeData.value))}else if(preTreeData&&!postTreeData){my.maxSize(preTreeData.value)}else{my.maxSize(postTreeData.value);$("#"+targetElementId+"previs").empty()}var previs=d3.select("#"+targetElementId+"previs");var vis=d3.select("#"+targetElementId+"vis");previs.empty();vis.empty();d3TreeLayout.size([my.height()-(my.margins()[0]+my.margins()[2]),my.width()-(my.margins()[1]+my.margins()[3])/2]);if(preTreeData){update(preTreeData,"pre",d3.select("#"+targetElementId+"previs"),d3TreeLayout)}if(!postTreeData){postTreeData={cleanName:searchTerm,depth:0,value:my.maxSize()}}update(postTreeData,"post",d3.select("#"+targetElementId+"vis"),d3TreeLayout)})}my.mouseoverText=function(value){if(!arguments.length)return mouseoverText;mouseoverText=value;return my};my.maxSize=function(value){if(!arguments.length)return maxSize;maxSize=value;return my};my.onButtonClick=function(value){if(!arguments.length)return onButtonClick;onButtonClick=value;return my};my.useButtonNav=function(value){if(!arguments.length)return useButtonNav;useButtonNav=value;return my};my.buttonText=function(value){if(!arguments.length)return buttonText;buttonText=value;return my};my.width=function(value){if(!arguments.length)return width;width=value;textSizeMultiplier=value/2e3;return my};my.height=function(value){if(!arguments.length)return height;height=value;return my};my.textSizeMultiplier=function(value){if(!arguments.length)return textSizeMultiplier;textSizeMultiplier=value;return my};my.margins=function(value){if(!arguments.length)return margins;margins=value;return my};my.preTreeData=function(value){if(!arguments.length)return preTreeData;preTreeData=value;return my};my.postTreeData=function(value){if(!arguments.length)return postTreeData;postTreeData=value;return my};my.matchingTerms=function(value){if(!arguments.length)return matchingTerms;matchingTerms=value;return my};my.nameAccessor=function(value){if(!arguments.length)return nameAccessor;nameAccessor=value;return my};my.valueAccessor=function(value){if(!arguments.length)return valueAccessor;valueAccessor=value;return my};my.onClick=function(value){if(!arguments.length)return onClick;onClick=value;return my};my.searchTerm=function(value){if(!arguments.length)return searchTerm;searchTerm=value;return my};my.maxResults=function(value){if(!arguments.length)return maxResults;maxResults=value;return my};my.maxDepth=function(value){if(!arguments.length)return maxDepth;maxDepth=value;return my};function extractRelevantData(inputData){var extractedData=[];var iteratorLimit=Math.min(inputData.length,my.maxResults());var nameAccessFunction=my.nameAccessor();var valueAccessFunction=my.valueAccessor();for(var i=0;i<iteratorLimit;i++){var newItem={};newItem.name=nameAccessFunction(inputData[i]);newItem.value=valueAccessFunction(inputData[i]);extractedData.push(newItem)}return extractedData}function update(source,preOrPost,visualisation,d3TreeLayout){source.x0=my.height()/2;source.y0=0;var duration=500;var nodes=d3TreeLayout.nodes(source).reverse();var searchTermWidth=getSearchTermWidth(nodes);var treeData=prepareTreeData(nodes,source,preOrPost,searchTermWidth);var d3NodeData=visualisation.selectAll("g.node,g.buttonnode").data(treeData,function(d){return d.id||(d.id=++nodeIDCounter)});drawRootLink(searchTermWidth,my.height()/2);drawNodes(d3NodeData,preOrPost,source,duration);var d3LinkData=visualisation.selectAll("path.link,path.buttonlink").data(d3TreeLayout.links(treeData),function(d){return d.target.id});drawLinks(d3LinkData,preOrPost,duration,source);d3NodeData.forEach(function(d){d.x0=d.x;d.y0=d.y})}function getSearchTermWidth(nodes){var rootNode=getRoot(nodes[0]);rootNode.value=my.maxSize();return getTextWidth(rootNode.cleanName,rootNode.value)}function prepareTreeData(nodes,source,preOrPost,searchTermWidth){var depthWidths=[];nodes.forEach(function(d){var widthForThisNode=getTextWidth(getNodeText(d,preOrPost),d.value);if(depthWidths[d.depth]){if(depthWidths[d.depth]<widthForThisNode){depthWidths[d.depth]=widthForThisNode}}else{depthWidths[d.depth]=widthForThisNode}});var availableSpaceRatio=getAvailableSpaceRatio(depthWidths,getSpaceForTree(searchTermWidth));while(availableSpaceRatio>1.1||availableSpaceRatio<.9){searchTermWidth=getSearchTermWidth(nodes);spaceForTree=getSpaceForTree(searchTermWidth);depthWidths=adjustDepthsForAvailableSpace(depthWidths,spaceForTree,availableSpaceRatio);availableSpaceRatio=getAvailableSpaceRatio(depthWidths,getSpaceForTree(searchTermWidth))}nodes.forEach(function(d){d.y=getYPosition(d,searchTermWidth,depthWidths,preOrPost);if(d.depth>my.maxDepth()){d.visible=false}else{d.visible=true;if(d.depth==0){d.x=my.height()/2}}});nodes=nodes.filter(function(d){return d.visible==true||d.isButton==true});return nodes}function getAvailableSpaceRatio(depthWidths,spaceForTree){var maxDepth=my.maxDepth();var requiredSpace=0;for(var i=0;i<Math.min(maxDepth+1,depthWidths.length);i++){requiredSpace+=depthWidths[i]}var availableSpaceUsed=requiredSpace/spaceForTree;return availableSpaceUsed}function adjustDepthsForAvailableSpace(depthWidths,spaceForTree,availableSpaceUsed){for(var i=0;i<Math.min(maxDepth+1,depthWidths.length);i++){depthWidths[i]=depthWidths[i]/availableSpaceUsed}if(availableSpaceUsed>1){my.textSizeMultiplier(my.textSizeMultiplier()/availableSpaceUsed)}return depthWidths}function highlightBothTrees(thisNode){var expressionID=thisNode.matchingTermIndex;highlightTree("pre",expressionID);highlightTree("post",expressionID)}function highlightTree(preOrPost,expressionID){var treeData=getTreeData(preOrPost);if(treeData){recursivelySetHighlight(treeData,preOrPost,expressionID)}}function recursivelySetHighlight(node,preOrPost,expressionID){setHighlightIfExpressionIDMatches(node,expressionID,preOrPost);for(var i=0;i<node.children.length;i++){recursivelySetHighlight(node.children[i],preOrPost,expressionID)}}function setHighlightIfExpressionIDMatches(node,expressionID,preOrPost){if(node.isButton==false){var nodeTermIndexArray=node.matchingTermIndex.split(",");var expressionIDArray=expressionID.split(",");for(var i=0;i<nodeTermIndexArray.length;i++){for(var j=0;j<expressionIDArray.length;j++){if(nodeTermIndexArray[i]==expressionIDArray[j]){setHighlight(true,node,preOrPost)}}}}}function getNodeById(id,node){if(node.id==id){return node}else{for(var i=0;i<node.children.length;i++){var possibleResponse=getNodeById(id,node.children[i]);if(possibleResponse!=false){return possibleResponse}}}return false}function getNodeFromBothTrees(id){var preRoot=getRoot(getTreeData("pre"));var postRoot=getRoot(getTreeData("post"));var result=false;if(preRoot){result=getNodeById(id,preRoot)}if(result==false&&postRoot){result=getNodeById(id,postRoot)}return result}function getLeafArray(node,leafArray,firstTime,preOrPost){if(firstTime){if(node==getRoot(node)){var otherTreeData=getTreeData(getOther(preOrPost));if(otherTreeData){var otherTreeRoot=getRoot(otherTreeData);leafArray.concat(getLeafArray(otherTreeRoot,leafArray,false,getOther(preOrPost)))}}else{node=getRoot(node)}}if(node.isLeaf==true){var newItem={};newItem.id=node.id;newItem.preOrPost=preOrPost;leafArray.push(newItem)}for(var i=0;i<node.children.length;i++){leafArray.concat(getLeafArray(node.children[i],leafArray,false,preOrPost))}return leafArray}function getHighlightedLeaf(root,otherTreeRoot){highlightedLeafInFirstTree=getHighlightFromTree(root);if(highlightedLeafInFirstTree==false){return getHighlightFromTree(otherTreeRoot)}else{return highlightedLeafInFirstTree}}function getHighlightFromTree(node,preOrPost){var result=false;if(node){if(node.children.length>0){for(var i=0;i<node.children.length;i++){if(node.children[i].highlighted){result=getHighlightFromTree(node.children[i],preOrPost)}}}else{result=node;result.name=result.name.replace(/_/g," ")}}return result}function getRoot(node){if(node){if(node.depth==0){return node}else{return getRoot(node.parent)}}return false}function setHighlight(on,node,preOrPost){node.highlighted=on;if(on){$("#"+preOrPost+"-"+node.id).attr("class","link highlight");$("#"+preOrPost+"-link-"+node.id).attr("class","link highlight");if(node.depth==0){$("#rootnode").attr("class","link highlight");$("#rootlink").attr("class","link highlight")}}else{$("#"+preOrPost+"-"+node.id).attr("class","link");$("#"+preOrPost+"-link-"+node.id).attr("class","link");if(node.depth==0){$("#rootnode").attr("class","link");$("#rootlink").attr("class","link")}}}function removeHighlight(node,preOrPost){if(node){setHighlight(false,node,preOrPost);for(var i=0;i<node.children.length;i++){if(node.children[i].highlighted==true){removeHighlight(node.children[i],preOrPost)}}}}function getTreeData(preOrPost){var treeData;if(preOrPost=="pre"){treeData=my.preTreeData()}else{treeData=my.postTreeData()}return treeData}function getOther(preOrPost){if(preOrPost.toLowerCase()=="pre"){return"post"}else if(preOrPost.toLowerCase()=="post"){return"pre"}else{var err=new Error;err.message="invalid input";throw err}}function getFontSize(thisSize){if(thisSize==my.maxSize()){return Math.sqrt(thisSize/my.maxSize()*800*my.textSizeMultiplier())+14}else{return Math.pow(thisSize*3*my.textSizeMultiplier(),.7)+14}}function getTextWidth(text,thisSize){var element=$("<text>i</text>").css({visibility:"hidden"}).appendTo($("#previs"));var marginForCircle=20;var fontStyle=element.css("font-style");var fontVariant=element.css("font-variant");var fontWeight=element.css("font-weight");var fontFamily=element.css("font-family");element.remove();var font=fontStyle+" "+fontVariant+" "+fontWeight+" "+getFontSize(thisSize)+"px "+fontFamily;var o=$("<text>"+text+"</text>").css({position:"absolute","float":"left","white-space":"nowrap",visibility:"hidden",font:font}).appendTo($("body")),width=o.width();o.remove();return width+marginForCircle}function getYPosition(d,searchTermWidth,depthWidths,preOrPost){var yPosition=0;for(var i=d.depth;i>0;i--){yPosition+=depthWidths[i]}if(preOrPost=="pre"){return my.width()/2-yPosition-searchTermWidth}else{return yPosition+searchTermWidth}}function getSpaceForTree(searchTermWidth){var margins=my.margins();var availableSpace=my.width()-(margins[1]+margins[3]);var spaceForTree=(availableSpace-searchTermWidth)/2;return spaceForTree}function drawNodes(d3NodeData,preOrPost,source,duration){addNewNodes(d3NodeData,preOrPost,source);transitionExistingNodes(d3NodeData);removeOldNodes(d3NodeData,duration,source)}function drawRootLink(searchTermWidth,height){if($("#rootlink").length==0){d3.select("#vis").append("svg:line").attr("x1",-searchTermWidth).attr("x2",0).attr("y1",height).attr("y2",height).attr("id","rootlink").attr("stroke-width",30).attr("class","link")}else{$("#rootlink").attr("x1",-searchTermWidth).attr("x2",0).attr("y1",height).attr("y2",height)}}function drawLinks(d3LinkData,preOrPost,duration,source){addNewLinks(d3LinkData,preOrPost,duration,source);transitionExistingLinks(d3LinkData,duration);removeOldLinks(d3LinkData,source,duration)}function addNewNodes(nodes,preOrPost,source){var onClickBehaviour=my.onClick();var onButtonClickBehaviour=my.onButtonClick();var mouseoverText=my.mouseoverText();var nodeEnter=nodes.enter().append("svg:g").attr("class",function(d){return d.isButton?"buttonnode":"node"}).attr("transform",function(d){return"translate("+source.y0+","+source.x0+")"}).on("mouseover",showLinkButton).on("mouseout",hideLinkButton).on("click",onClickBehaviour);nodeEnter.append("svg:circle").attr("r",1e-6).style("fill",function(d){return d._children?"lightsteelblue":"#fff"}).style("opacity",function(d){return d.isButton?0:1});nodeEnter.append("svg:rect").attr("height",function(d){return getFontSize(d.value)+4}).attr("width",function(d){return getTextWidth(getNodeText(d,preOrPost),d.value)*.9}).attr("x",function(d){return preOrPost=="pre"?0:-getTextWidth(getNodeText(d,preOrPost),d.value)*.9}).attr("y",function(d){return getFontSize(d.value)/-2}).attr("ry","3px").attr("rx","3px").attr("opacity",function(d){return d.isButton?.15:0}).attr("id",function(d){return preOrPost+"-"+d.id+"rect"}).attr("class",function(d){return d.isButton?"buttonnode":"node"});nodeEnter.append("svg:text").attr("x",function(d){return preOrPost=="pre"?10:-10}).attr("dy",".35em").attr("text-anchor",function(d){return preOrPost=="pre"?"start":"end"}).attr("font-size",function(d){return getFontSize(d.value)}).attr("opacity",function(d){return d.isButton?.15:Math.sqrt(d.value/my.maxSize())>.25?1:.5}).attr("id",function(d){return preOrPost=="pre"?preOrPost+"-"+d.id:d.depth==0?"rootnode":"post-"+d.id}).text(function(d){return getNodeText(d,preOrPost)}).style("fill-opacity",1e-6).append("svg:title").text(mouseoverText)}function getNodeText(d,preOrPost){var result="";var name="";if(d.pluralAndSingular){name=d.ambiguousName}else{name=d.cleanName}name=name.replace(/_/g," ");if(d.depth==0&&preOrPost=="pre"){result=""}else{result=name}return result}function transitionExistingNodes(nodes,duration){var nodeUpdate=nodes.transition().duration(duration).attr("transform",function(d){return"translate("+d.y+","+d.x+")"});nodeUpdate.select("circle").attr("r",function(d){if(my.textSizeMultiplier()>.5){return 4.5}else{return 0}}).style("fill",function(d){return d._children?"lightsteelblue":"#fff"}).style("stroke",function(d){return d.cleanName==""?"#fff":"steelblue"});nodeUpdate.select("text").attr("font-size",function(d){return getFontSize(d.value)}).style("fill-opacity",1)}function removeOldNodes(nodes,duration,source){var nodeExit=nodes.exit().transition().duration(duration).attr("transform",function(d){return"translate("+source.y+","+source.x+")"}).remove();nodeExit.select("circle").attr("r",1e-6);nodeExit.select("text").style("fill-opacity",1e-6)}function addNewLinks(d3LinkData,preOrPost,duration,source){d3LinkData.enter().insert("svg:path","g").attr("class",function(d){return d.target.isButton?"buttonlink":"link"}).attr("opacity",function(d){return d.target.isButton?0:.2}).attr("id",function(d){return d.depth==0?"rootlink":preOrPost+"-link-"+d.target.id}).attr("d",function(d){var o={x:source.x0,y:source.y0};return diagonal({source:o,target:o})}).attr("stroke-width",function(d){return Math.sqrt(d.target.value/my.maxSize()*1e3)}).on("mouseover",showLinkButton).on("mouseout",hideLinkButton).transition().duration(duration).attr("d",diagonal)}function transitionExistingLinks(d3LinkData,duration){d3LinkData.transition().duration(duration).attr("d",diagonal)}function removeOldLinks(d3LinkData,source,duration){d3LinkData.exit().transition().duration(duration).attr("d",function(d){var o={x:source.x,y:source.y};return diagonal({source:o,target:o})}).remove()}function showLinkButton(d){if(d.target){d=d.target}setLinkButtonVisibilityTo.call(this,true,d)}function hideLinkButton(d){if(d.target){d=d.target}setLinkButtonVisibilityTo.call(this,false,d)}function setLinkButtonVisibilityTo(On,d){var id=this.id||this.lastChild.id;var preOrPost=id.substr(0,id.indexOf("-"));var childButtonIds=[];findChildButtons(d,childButtonIds);if(preOrPost+"-"+childButtonIds[0]==id){if(On){highlightBothTrees(this.__data__)}else{var root=getRoot(this.__data__);var otherTreeData=getTreeData(getOther(preOrPost));var otherTreeRoot=getRoot(otherTreeData);removeHighlight(root,preOrPost);removeHighlight(otherTreeRoot,getOther(preOrPost))}}var opacity=On?1:.15;for(var i=0;i<childButtonIds.length;i++){$("#"+preOrPost+"-"+childButtonIds[i].toString()).attr("opacity",opacity);$("#"+preOrPost+"-"+childButtonIds[i].toString()+"rect").attr("opacity",opacity)}}function findChildButtons(node,childButtonIds){if(node.isButton){childButtonIds.push(node.id)}for(var i=0;i<node.children.length;i++){childButtonIds=findChildButtons(node.children[i],childButtonIds)}return childButtonIds}var nodeIDCounter=0;var diagonal=d3.svg.diagonal().projection(function(d){return[d.y,d.x]});if(!testMode){return my}else{return{my:my,lastWordIsNotSearchTerm:lastWordIsNotSearchTerm,firstWordIsNotSearchTerm:firstWordIsNotSearchTerm,removeTrailingPunctuation:removeTrailingPunctuation,pruneTerm:pruneTerm,mergeTrees:mergeTrees,nestTreeData:nestTreeData,createTerm:createTerm,processTreeData:processTreeData,handleSpacesInMultiWordSearchTerm:handleSpacesInMultiWordSearchTerm,createTree:createTree}}}